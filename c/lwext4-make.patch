diff --git a/CMakeLists.txt b/CMakeLists.txt
index eec0993..ee36a4d 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -43,10 +43,16 @@ else()
       set(BLOCKDEV_TYPE  linux)
     endif()
     set (INSTALL_LIB 1)
-    add_definitions(-DCONFIG_HAVE_OWN_OFLAGS=0)
-    add_definitions(-DCONFIG_HAVE_OWN_ERRNO=0)
-    add_definitions(-DCONFIG_HAVE_OWN_ASSERT=0)
+
+    add_definitions(-DCONFIG_DEBUG_PRINTF=1)
+    add_definitions(-DCONFIG_DEBUG_ASSERT=1)
+
+    add_definitions(-DCONFIG_HAVE_OWN_OFLAGS=1)
+    add_definitions(-DCONFIG_HAVE_OWN_ERRNO=1)
+    add_definitions(-DCONFIG_HAVE_OWN_ASSERT=1)
+    add_definitions(-DCONFIG_USE_USER_MALLOC=1)
     add_definitions(-DCONFIG_BLOCK_DEV_CACHE_SIZE=16)
+
     add_subdirectory(fs_test)
 endif()
 
diff --git a/Makefile b/Makefile
index 12ee5c7..0ef73ca 100644
--- a/Makefile
+++ b/Makefile
@@ -19,6 +19,9 @@ COMMON_DEFINITIONS =                                      \
 	-DVERSION_MINOR=$(VERSION_MINOR)                      \
 	-DVERSION_PATCH=$(VERSION_PATCH)                      \
 	-DVERSION=$(VERSION)                                  \
+	-DLWEXT4_BUILD_SHARED_LIB=OFF \
+	-DLWEXT4_ULIBC=$(ULIBC) \
+	-DCMAKE_INSTALL_PREFIX=./install \
 
 define generate_common
 	rm -R -f build_$(1)
@@ -29,6 +32,13 @@ define generate_common
 	-DCMAKE_TOOLCHAIN_FILE=../toolchain/$(1).cmake ..
 endef
 
+ARCH ?= x86_64
+#Output: src/liblwext4.a
+musl-generic:
+	$(call generate_common,$@)
+	cd build_$@ && make lwext4
+	cp build_$@/src/liblwext4.a ./liblwext4-$(ARCH).a
+
 generic:
 	$(call generate_common,$@)
 
diff --git a/include/ext4_types.h b/include/ext4_types.h
index c9cdd34..b69936d 100644
--- a/include/ext4_types.h
+++ b/include/ext4_types.h
@@ -822,6 +822,11 @@ struct jbd_sb {
 
 #if CONFIG_USE_USER_MALLOC
 
+void *ext4_user_malloc(size_t size);
+void *ext4_user_calloc(size_t nmemb, size_t size);
+void *ext4_user_realloc(void *ptr, size_t size);
+void ext4_user_free(void *ptr);
+
 #define ext4_malloc  ext4_user_malloc
 #define ext4_calloc  ext4_user_calloc
 #define ext4_realloc ext4_user_realloc
diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 257b8cc..b330e70 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -1,13 +1,20 @@
 
 option(LWEXT4_BUILD_SHARED_LIB "Build shared library" OFF)
+option(LWEXT4_ULIBC "Build ulibc" OFF)
 
 #LIBRARY
 include_directories(.)
 aux_source_directory(. LWEXT4_SRC)
+set(M_SRC "../../ulibc.c")
+
+if(LWEXT4_ULIBC)
+  add_definitions(-DLWEXT4_ULIBC)
+endif()
+
 if(LWEXT4_BUILD_SHARED_LIB)
   add_library(lwext4 SHARED ${LWEXT4_SRC})
 else()
-  add_library(lwext4 STATIC ${LWEXT4_SRC})
+  add_library(lwext4 STATIC ${LWEXT4_SRC} ${M_SRC})
 endif()
 
 if  (DEFINED SIZE)
